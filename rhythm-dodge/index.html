<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Rhythm Dodge — Flux ⚡</title>
  <style>
    :root { --ui:#dbe3ff; --accent:#7a5cff; --bg:#0a0a12; }
    *{box-sizing:border-box} html,body{margin:0;height:100%;overflow:hidden;background:var(--bg);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;color:var(--ui)}
    #app{position:fixed;inset:0}
    .hud{position:fixed;top:12px;left:12px;z-index:20;background:rgba(8,10,20,.58);border:1px solid rgba(122,92,255,.35);border-radius:10px;padding:10px 12px;backdrop-filter:blur(8px);min-width:220px}
    .row{display:flex;justify-content:space-between;gap:10px;font-size:12px;line-height:1.4}
    .label{opacity:.7}.v{font-weight:700;color:#fff}
    .controls{margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,.1);font-size:11px;opacity:.8}
    .topbar{position:fixed;top:12px;right:12px;z-index:25;display:flex;gap:8px}
    button, .btn{appearance:none;border:1px solid rgba(255,255,255,.22);background:rgba(16,18,30,.75);color:#eef2ff;padding:8px 10px;border-radius:8px;font-size:12px;cursor:pointer;text-decoration:none}
    button:hover,.btn:hover{border-color:var(--accent)}
    #overlay{position:fixed;inset:0;z-index:30;display:flex;align-items:center;justify-content:center;background:radial-gradient(circle at center, rgba(122,92,255,.18), rgba(0,0,0,.7));}
    .panel{width:min(92vw,460px);padding:18px;border:1px solid rgba(122,92,255,.4);background:rgba(10,12,24,.86);border-radius:12px;text-align:center}
    h1{margin:0 0 10px;font-size:32px;letter-spacing:.06em}
    .sub{font-size:13px;opacity:.82;margin-bottom:14px}
    .cta{display:flex;justify-content:center;gap:8px;flex-wrap:wrap}
    #touchHint{position:fixed;left:50%;bottom:12px;transform:translateX(-50%);z-index:20;font-size:11px;opacity:.7;background:rgba(0,0,0,.35);padding:5px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.14)}
    .watermark{position:fixed;right:12px;bottom:10px;z-index:20;opacity:.3;letter-spacing:.08em;font-size:11px;color:#fff;pointer-events:none}
    .flash{position:fixed;inset:0;pointer-events:none;z-index:5;mix-blend-mode:screen;background:radial-gradient(circle at center, rgba(122,92,255,.24), transparent 50%);opacity:0;transition:opacity .08s linear}
  </style>
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>
<body>
  <div id="app"></div>
  <div class="flash" id="flash"></div>

  <div class="topbar">
    <a class="btn" href="../">← GALLERY</a>
    <button id="qualityBtn" title="Cycle quality">Quality: MED</button>
    <button id="muteBtn">Sound: ON</button>
  </div>

  <div class="hud">
    <div class="row"><span class="label">SCORE</span><span class="v" id="score">0</span></div>
    <div class="row"><span class="label">COMBO</span><span class="v" id="combo">x1</span></div>
    <div class="row"><span class="label">TIME</span><span class="v" id="time">0.0s</span></div>
    <div class="row"><span class="label">BEST</span><span class="v" id="best">0</span></div>
    <div class="controls">Move: WASD / Arrows / touch drag<br/>Dodge on beat for combo bonus</div>
  </div>

  <div id="overlay">
    <div class="panel">
      <h1>RHYTHM DODGE</h1>
      <div class="sub">Beat-synced obstacles. Survive, thread close calls, stack combo.</div>
      <div class="cta">
        <button id="startBtn">Start Run</button>
        <button id="restartBtn" style="display:none">Retry</button>
      </div>
      <div id="result" class="sub" style="margin-top:12px;min-height:18px"></div>
    </div>
  </div>

  <div id="touchHint">Touch: drag anywhere to steer</div>
  <div class="watermark">HEARTBREAK INK</div>

  <script type="module">
    import * as THREE from 'three';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

    const Q = {
      low: { pixel: 1, particles: 60, shadows: false, maxObs: 16 },
      med: { pixel: Math.min(window.devicePixelRatio, 1.5), particles: 130, shadows: true, maxObs: 22 },
      high:{ pixel: Math.min(window.devicePixelRatio, 2), particles: 240, shadows: true, maxObs: 32 }
    };
    let quality = localStorage.getItem('rd_quality') || 'med';

    const app = document.getElementById('app');
    const flash = document.getElementById('flash');
    const el = id => document.getElementById(id);

    const scene = new THREE.Scene();
    scene.background = new THREE.Color('#0a0a12');
    scene.fog = new THREE.FogExp2('#0a0a12', 0.06);

    const camera = new THREE.PerspectiveCamera(62, innerWidth/innerHeight, 0.1, 120);
    camera.position.set(0, 7.2, 10.4);
    camera.lookAt(0,0,0);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    app.appendChild(renderer.domElement);

    const composer = new EffectComposer(renderer);
    const rp = new RenderPass(scene, camera);
    const bloom = new UnrealBloomPass(new THREE.Vector2(innerWidth, innerHeight), 0.85, 0.4, 0.22);
    composer.addPass(rp); composer.addPass(bloom);

    // HBI-style lighting
    const key = new THREE.DirectionalLight('#4488ff', 2.0); key.position.set(3,4,2); scene.add(key);
    const fill = new THREE.DirectionalLight('#ff6633', 0.8); fill.position.set(-3,2,-1); scene.add(fill);
    const rim = new THREE.DirectionalLight('#ffffff', 1.5); rim.position.set(0,3,-3); scene.add(rim);
    const amb = new THREE.AmbientLight('#6677aa', 0.35); scene.add(amb);

    const arena = new THREE.Mesh(
      new THREE.CylinderGeometry(6.5, 6.5, 0.6, 64, 1, true),
      new THREE.MeshStandardMaterial({ color:'#111425', emissive:'#1f1849', emissiveIntensity:.4, roughness:.55, metalness:.24, side:THREE.DoubleSide })
    );
    arena.position.y = -0.3; scene.add(arena);

    const ring = new THREE.Mesh(
      new THREE.TorusGeometry(6.2, 0.1, 18, 128),
      new THREE.MeshBasicMaterial({ color:'#6f63ff' })
    );
    ring.rotation.x = Math.PI/2; ring.position.y = 0.03; scene.add(ring);

    const player = new THREE.Mesh(
      new THREE.IcosahedronGeometry(0.42, 1),
      new THREE.MeshStandardMaterial({ color:'#d3e6ff', emissive:'#7a5cff', emissiveIntensity:1.2, roughness:.2, metalness:.5 })
    );
    player.position.set(0,0.45,0); scene.add(player);

    const trailGeo = new THREE.BufferGeometry();
    const trailPts = Array.from({length:32},()=>new THREE.Vector3());
    trailGeo.setFromPoints(trailPts);
    const trail = new THREE.Line(trailGeo, new THREE.LineBasicMaterial({color:'#8b82ff', transparent:true, opacity:.55}));
    scene.add(trail);

    let particles, pMat;
    function buildParticles(count){
      if (particles) { scene.remove(particles); particles.geometry.dispose(); pMat.dispose(); }
      const g = new THREE.BufferGeometry();
      const arr = new Float32Array(count*3);
      for(let i=0;i<count;i++){ arr[i*3]=(Math.random()-0.5)*14; arr[i*3+1]=Math.random()*4+0.1; arr[i*3+2]=(Math.random()-0.5)*14; }
      g.setAttribute('position', new THREE.BufferAttribute(arr,3));
      pMat = new THREE.PointsMaterial({size:0.05,color:'#7a7cff',transparent:true,opacity:.7});
      particles = new THREE.Points(g,pMat); scene.add(particles);
    }

    const obsGeo = new THREE.BoxGeometry(0.7, 1, 0.7);
    const obstacles = [];

    const state = {
      running:false, score:0, combo:1, time:0, best:Number(localStorage.getItem('rd_best')||0),
      beatTimer:0, beatIndex:0, bpm:126, spawnCount:1, nearMissCooldown:0,
      move:new THREE.Vector2(), touchActive:false, target:new THREE.Vector2(),
      muted:false, pulse:0
    };

    el('best').textContent = state.best;

    function applyQuality(){
      const q = Q[quality];
      renderer.setPixelRatio(q.pixel); renderer.setSize(innerWidth, innerHeight);
      composer.setSize(innerWidth, innerHeight);
      key.castShadow = fill.castShadow = rim.castShadow = q.shadows;
      buildParticles(q.particles);
      el('qualityBtn').textContent = `Quality: ${quality.toUpperCase()}`;
      localStorage.setItem('rd_quality', quality);
    }

    function createObstacle(){
      if (obstacles.length > Q[quality].maxObs) return;
      const angle = Math.random()*Math.PI*2;
      const radius = 7.2;
      const mesh = new THREE.Mesh(obsGeo, new THREE.MeshStandardMaterial({ color:'#ff4d77', emissive:'#ff2d66', emissiveIntensity:.7, roughness:.35, metalness:.4 }));
      mesh.position.set(Math.cos(angle)*radius, 0.5, Math.sin(angle)*radius);
      mesh.lookAt(0,0.5,0);
      scene.add(mesh);
      obstacles.push({ mesh, dir: new THREE.Vector3(-mesh.position.x,0,-mesh.position.z).normalize(), speed: 3.0 + Math.random()*1.1 + state.time*0.02, hit:false, near:false });
    }

    function startRun(){
      state.running = true; state.score=0; state.combo=1; state.time=0; state.beatTimer=0; state.spawnCount=1; state.beatIndex=0; state.pulse=0;
      state.move.set(0,0); state.target.set(0,0); player.position.set(0,0.45,0);
      obstacles.forEach(o=>{scene.remove(o.mesh); o.mesh.geometry.dispose(); o.mesh.material.dispose();}); obstacles.length=0;
      el('overlay').style.display='none'; el('restartBtn').style.display='none'; el('startBtn').style.display='inline-block'; el('result').textContent='';
      updateHud();
      kickAudio();
    }

    function gameOver(){
      state.running = false;
      if (state.score > state.best) { state.best = Math.floor(state.score); localStorage.setItem('rd_best', state.best); }
      el('best').textContent = state.best;
      el('overlay').style.display='flex';
      el('startBtn').style.display='none'; el('restartBtn').style.display='inline-block';
      el('result').textContent = `Crashed. Score ${Math.floor(state.score)} • Combo x${state.combo} • ${state.time.toFixed(1)}s`;
    }

    function updateHud(){
      el('score').textContent = Math.floor(state.score);
      el('combo').textContent = `x${state.combo}`;
      el('time').textContent = `${state.time.toFixed(1)}s`;
      el('best').textContent = state.best;
    }

    // Input
    const keys = new Set();
    addEventListener('keydown',e=>{ if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','w','a','s','d','W','A','S','D',' '].includes(e.key)) e.preventDefault(); keys.add(e.key.toLowerCase()); if(!state.running && e.key===' ') startRun(); });
    addEventListener('keyup',e=>keys.delete(e.key.toLowerCase()));

    addEventListener('pointerdown',e=>{ state.touchActive=true; onPointer(e); if (!audioCtx) initAudio(); });
    addEventListener('pointermove',e=>{ if(state.touchActive) onPointer(e); });
    addEventListener('pointerup',()=>state.touchActive=false);
    function onPointer(e){
      const nx = (e.clientX / innerWidth) * 2 - 1;
      const ny = (e.clientY / innerHeight) * 2 - 1;
      state.target.set(nx*5.2, ny*3.5);
    }

    // Audio + reactive pulse
    let audioCtx, master, analyser;
    function initAudio(){
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      master = audioCtx.createGain(); master.gain.value = 0.5;
      analyser = audioCtx.createAnalyser(); analyser.fftSize = 256;
      master.connect(analyser); analyser.connect(audioCtx.destination);
    }
    function tone(freq=140, len=0.09, type='triangle', vol=0.18){
      if (!audioCtx || state.muted) return;
      const t0 = audioCtx.currentTime;
      const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
      o.type = type; o.frequency.setValueAtTime(freq, t0); o.frequency.exponentialRampToValueAtTime(freq*0.75, t0+len);
      g.gain.setValueAtTime(vol, t0); g.gain.exponentialRampToValueAtTime(0.0001, t0+len);
      o.connect(g); g.connect(master); o.start(t0); o.stop(t0+len+0.02);
    }
    function kickAudio(){ tone(86, 0.08, 'sine', 0.26); tone(150, 0.04, 'triangle', 0.12); }

    el('muteBtn').onclick = ()=>{ state.muted = !state.muted; el('muteBtn').textContent = `Sound: ${state.muted ? 'OFF':'ON'}`; if(!audioCtx) initAudio(); };
    el('qualityBtn').onclick = ()=>{ quality = quality==='low'?'med':quality==='med'?'high':'low'; applyQuality(); };
    el('startBtn').onclick = ()=>{ if(!audioCtx) initAudio(); startRun(); };
    el('restartBtn').onclick = ()=> startRun();

    function resize(){
      camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight); composer.setSize(innerWidth, innerHeight); bloom.setSize(innerWidth, innerHeight);
    }
    addEventListener('resize', resize);

    applyQuality(); resize();

    const clock = new THREE.Clock();
    function tick(){
      const dt = Math.min(clock.getDelta(), 0.033);
      const t = clock.elapsedTime;

      const beatDur = 60/state.bpm;
      if (state.running){
        state.time += dt;
        state.beatTimer += dt;
        const mv = new THREE.Vector2(
          (keys.has('arrowright')||keys.has('d')?1:0) - (keys.has('arrowleft')||keys.has('a')?1:0),
          (keys.has('arrowdown')||keys.has('s')?1:0) - (keys.has('arrowup')||keys.has('w')?1:0)
        );
        if (mv.lengthSq()>0) state.target.addScaledVector(mv.normalize(), dt*8.2);
        state.target.x = THREE.MathUtils.clamp(state.target.x,-5.4,5.4);
        state.target.y = THREE.MathUtils.clamp(state.target.y,-4.2,4.2);

        player.position.x = THREE.MathUtils.damp(player.position.x, state.target.x, 7, dt);
        player.position.z = THREE.MathUtils.damp(player.position.z, state.target.y, 7, dt);
        if (player.position.length() > 5.8) {
          const flat = new THREE.Vector2(player.position.x, player.position.z).normalize().multiplyScalar(5.8);
          player.position.x = flat.x; player.position.z = flat.y;
        }

        if (state.beatTimer >= beatDur){
          state.beatTimer -= beatDur;
          state.beatIndex++;
          state.pulse = 1;
          flash.style.opacity = '0.65'; setTimeout(()=>flash.style.opacity='0', 60);
          ring.scale.setScalar(1 + 0.06*Math.sin(state.beatIndex));
          kickAudio();

          const extra = 1 + Math.floor(state.time / 24);
          for(let i=0;i<Math.min(3, extra);i++) createObstacle();

          if (state.beatIndex % 8 === 0 && state.bpm < 160) state.bpm += 1;
          state.score += 10 * state.combo;
        }

        state.nearMissCooldown -= dt;

        for(let i=obstacles.length-1;i>=0;i--){
          const o = obstacles[i];
          o.mesh.position.addScaledVector(o.dir, dt*o.speed);
          o.mesh.rotation.y += dt*2;

          const dist = o.mesh.position.distanceTo(player.position);
          if (dist < 0.72){ tone(60,0.2,'sawtooth',0.22); gameOver(); break; }
          if (!o.near && dist < 1.4 && state.nearMissCooldown <= 0){
            o.near = true; state.nearMissCooldown = 0.18; state.combo = Math.min(30, state.combo+1); state.score += 20*state.combo; tone(520,0.05,'square',0.09);
          }
          if (o.mesh.position.length() < 0.25 || o.mesh.position.length()>9){
            scene.remove(o.mesh); o.mesh.geometry.dispose(); o.mesh.material.dispose(); obstacles.splice(i,1);
          }
        }

        if (state.time % 5 < dt) state.combo = Math.max(1, state.combo-1);
        updateHud();
      }

      // pulse rule ambient motion
      state.pulse = Math.max(0, state.pulse - dt*2.8);
      const breathe = 0.8 + Math.sin(t*1.35)*0.2 + state.pulse*0.4;
      bloom.strength = 0.65 + breathe*0.35;
      key.intensity = 1.85 + Math.sin(t*1.8)*0.2 + state.pulse*0.4;
      fill.intensity = 0.7 + Math.sin(t*1.3+1.2)*0.12;
      rim.intensity = 1.35 + Math.sin(t*1.1+2.4)*0.16;
      camera.position.x = Math.sin(t*0.25)*0.35;
      camera.position.z = 10.4 + Math.cos(t*0.2)*0.15;
      camera.lookAt(0,0,0);

      player.rotation.x += dt*1.6; player.rotation.z += dt*1.2;
      arena.rotation.y += dt*0.08;
      ring.material.color.setHSL(0.71 + Math.sin(t*1.1)*0.02, 0.85, 0.58);

      const pos = particles.geometry.attributes.position;
      for(let i=0;i<pos.count;i++){
        let y = pos.getY(i) + dt*(0.3 + (i%7)*0.01);
        if (y>4.6) y = 0;
        pos.setY(i,y);
      }
      pos.needsUpdate = true;

      trailPts.pop(); trailPts.unshift(player.position.clone()); trailGeo.setFromPoints(trailPts);

      if (analyser && !state.muted){
        const data = new Uint8Array(analyser.frequencyBinCount); analyser.getByteFrequencyData(data);
        let sum=0; for(let i=0;i<20;i++) sum += data[i];
        const energy = sum/(20*255);
        arena.material.emissiveIntensity = 0.25 + energy*1.2;
        player.material.emissiveIntensity = 0.9 + energy*2.2;
      }

      composer.render();
      requestAnimationFrame(tick);
    }

    tick();
  </script>
</body>
</html>
